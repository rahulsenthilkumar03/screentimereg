<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Research Dashboard â€” Screen Time Study</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:#0d1117; --surface:#161b22; --surface2:#1c2330; --border:#21262d; --border2:#30363d;
  --text:#e6edf3; --text-muted:#7d8590; --text-dim:#484f58;
  --accent-irr:#f85149; --accent-att:#58a6ff; --accent-soc:#3fb950; --accent-yellow:#d29922;
  --accent-purple:#bc8cff; --accent-orange:#ffa657; --accent-control:#58a6ff; --accent-treatment:#f85149;
}
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'Outfit',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

/* LOGIN */
#login-screen { min-height:100vh; display:flex; align-items:center; justify-content:center;
  background:radial-gradient(ellipse at 30% 20%, rgba(88,166,255,0.07) 0%, transparent 60%),
              radial-gradient(ellipse at 70% 80%, rgba(248,81,73,0.06) 0%, transparent 60%), var(--bg); }
.login-box { background:var(--surface); border:1px solid var(--border2); border-radius:20px; padding:52px 44px; width:380px; text-align:center; box-shadow:0 24px 64px rgba(0,0,0,0.5); }
.login-logo { width:56px; height:56px; background:linear-gradient(135deg,#58a6ff,#bc8cff); border-radius:14px; display:flex; align-items:center; justify-content:center; margin:0 auto 24px; font-size:26px; }
.login-box h1 { font-family:'DM Serif Display',serif; font-size:24px; color:var(--text); margin-bottom:6px; }
.login-box p { color:var(--text-muted); font-size:14px; margin-bottom:32px; }
.login-box input { width:100%; padding:13px 16px; background:var(--bg); border:1px solid var(--border2); border-radius:10px; color:var(--text); font-family:'DM Mono',monospace; font-size:15px; outline:none; transition:border-color 0.2s; margin-bottom:14px; letter-spacing:2px; }
.login-box input:focus { border-color:#58a6ff; }
.login-btn { width:100%; padding:13px; background:linear-gradient(135deg,#1f6feb,#388bfd); color:#fff; border:none; border-radius:10px; font-family:'Outfit',sans-serif; font-size:16px; font-weight:600; cursor:pointer; transition:opacity 0.2s, transform 0.15s; }
.login-btn:hover { opacity:0.9; transform:translateY(-1px); }
.login-error { color:var(--accent-irr); font-size:13px; margin-top:12px; display:none; }

/* APP */
#app { display:none; min-height:100vh; }
.topbar { background:var(--surface); border-bottom:1px solid var(--border); padding:0 32px; height:60px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
.topbar-left { display:flex; align-items:center; gap:14px; }
.topbar-logo { width:32px; height:32px; background:linear-gradient(135deg,#58a6ff,#bc8cff); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:16px; }
.topbar-title { font-family:'DM Serif Display',serif; font-size:18px; color:var(--text); }
.topbar-badge { background:rgba(63,185,80,0.15); color:var(--accent-soc); font-size:11px; font-weight:600; padding:3px 10px; border-radius:20px; letter-spacing:1px; text-transform:uppercase; }
.topbar-right { display:flex; align-items:center; gap:10px; }
.top-btn { padding:7px 16px; border-radius:7px; border:1px solid var(--border2); background:transparent; color:var(--text-muted); font-family:'Outfit',sans-serif; font-size:13px; font-weight:500; cursor:pointer; transition:all 0.15s; }
.top-btn:hover { background:var(--surface2); color:var(--text); }
.top-btn.primary { background:#1f6feb; border-color:#1f6feb; color:#fff; }
.top-btn.primary:hover { background:#388bfd; }
.top-btn.danger { border-color:rgba(248,81,73,0.4); color:var(--accent-irr); }
.top-btn.danger:hover { background:rgba(248,81,73,0.15); }
.top-btn.secure { background:rgba(210,153,34,0.15); border-color:var(--accent-yellow); color:var(--accent-yellow); }
.top-btn.secure:hover { background:rgba(210,153,34,0.25); }

/* TABS */
.tabs-bar { background:var(--surface); border-bottom:1px solid var(--border); padding:0 32px; display:flex; gap:4px; }
.tab-btn { padding:14px 20px; font-family:'Outfit',sans-serif; font-size:14px; font-weight:500; color:var(--text-muted); background:none; border:none; cursor:pointer; border-bottom:2px solid transparent; transition:all 0.15s; white-space:nowrap; }
.tab-btn:hover { color:var(--text); }
.tab-btn.active { color:var(--accent-att); border-bottom-color:var(--accent-att); }

.main { padding:32px; max-width:1400px; margin:0 auto; }
.tab-panel { display:none; }
.tab-panel.active { display:block; }

/* STAT CARDS */
.stat-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px; margin-bottom:32px; }
.stat-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:22px 24px; position:relative; overflow:hidden; transition:border-color 0.2s; }
.stat-card:hover { border-color:var(--border2); }
.stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; border-radius:14px 14px 0 0; }
.stat-card.control::before { background:var(--accent-control); }
.stat-card.treatment::before { background:var(--accent-treatment); }
.stat-card.total::before { background:var(--accent-purple); }
.stat-card.paired::before { background:var(--accent-soc); }
.stat-label { font-size:11px; text-transform:uppercase; letter-spacing:1.5px; color:var(--text-muted); font-weight:600; margin-bottom:10px; }
.stat-value { font-family:'DM Serif Display',serif; font-size:36px; color:var(--text); line-height:1; }
.stat-sub { font-size:12px; color:var(--text-dim); margin-top:6px; }

/* CHARTS */
.chart-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:28px; }
@media(max-width:900px) { .chart-grid { grid-template-columns:1fr; } }
.chart-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:24px; }
.chart-card h3 { font-size:13px; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); font-weight:600; margin-bottom:20px; }
.chart-wrap { position:relative; height:240px; }
.chart-wrap-tall { position:relative; height:300px; }
.chart-card.wide { grid-column:span 2; }
@media(max-width:900px) { .chart-card.wide { grid-column:span 1; } }

/* PARTICIPANT CARDS */
.participant-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(400px,1fr)); gap:18px; }
.participant-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; overflow:hidden; transition:all 0.2s; animation:fadeUp 0.4s ease both; }
@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
.participant-card:hover { border-color:var(--border2); box-shadow:0 8px 24px rgba(0,0,0,0.3); }
.card-header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
.card-id { font-family:'DM Mono',monospace; font-size:14px; color:var(--text); font-weight:600; }
.card-group { font-size:11px; padding:4px 10px; border-radius:20px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.card-group.control { background:rgba(88,166,255,0.15); color:var(--accent-control); }
.card-group.treatment { background:rgba(248,81,73,0.15); color:var(--accent-treatment); }
.card-body { padding:16px 20px; }
.card-row { display:flex; justify-content:space-between; margin-bottom:10px; font-size:13px; }
.card-row:last-child { margin-bottom:0; }
.card-label { color:var(--text-muted); }
.card-value { color:var(--text); font-weight:500; }
.completion-status { display:flex; gap:8px; margin-top:12px; padding-top:12px; border-top:1px solid var(--border); }
.status-dot { width:10px; height:10px; border-radius:50%; }
.status-dot.complete { background:var(--accent-soc); }
.status-dot.incomplete { background:var(--text-dim); }
.status-label { font-size:11px; color:var(--text-muted); }

/* ITEM-LEVEL RESPONSES */
.card-scores { padding:16px 20px; border-top:1px solid var(--border); }
.score-row { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
.score-row:last-child { margin-bottom:0; }
.score-name { font-size:11px; color:var(--text-muted); text-transform:uppercase; min-width:80px; }
.score-track { flex:1; height:8px; background:var(--bg); border-radius:4px; overflow:hidden; position:relative; }
.score-fill { height:100%; border-radius:4px; transition:width 0.3s; }
.score-fill.fill-irr { background:linear-gradient(90deg,rgba(248,81,73,0.4),var(--accent-irr)); }
.score-fill.fill-att { background:linear-gradient(90deg,rgba(88,166,255,0.4),var(--accent-att)); }
.score-fill.fill-soc { background:linear-gradient(90deg,rgba(63,185,80,0.4),var(--accent-soc)); }
.score-fill.fill-total { background:linear-gradient(90deg,rgba(188,140,255,0.4),var(--accent-purple)); }
.score-num { font-family:'DM Mono',monospace; font-size:13px; color:var(--text); font-weight:600; min-width:50px; text-align:right; }

.card-items { padding:16px 20px; border-top:1px solid var(--border); }
.items-label { font-size:10px; text-transform:uppercase; letter-spacing:1px; color:var(--text-dim); margin-bottom:10px; font-weight:600; }
.items-grid { display:grid; grid-template-columns:repeat(15,1fr); gap:6px; }
.item-dot { width:100%; aspect-ratio:1; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; position:relative; cursor:pointer; transition:transform 0.15s; border:1px solid rgba(255,255,255,0.1); }
.item-dot:hover { transform:scale(1.15); z-index:10; }
.item-dot.dot-1 { background:rgba(63,185,80,0.3); color:#3fb950; border-color:#3fb950; }
.item-dot.dot-2 { background:rgba(88,166,255,0.3); color:#58a6ff; border-color:#58a6ff; }
.item-dot.dot-3 { background:rgba(210,153,34,0.3); color:#d29922; border-color:#d29922; }
.item-dot.dot-4 { background:rgba(255,166,87,0.3); color:#ffa657; border-color:#ffa657; }
.item-dot.dot-5 { background:rgba(248,81,73,0.3); color:#f85149; border-color:#f85149; }
.item-q { position:absolute; top:-16px; left:50%; transform:translateX(-50%); font-size:8px; color:var(--text-dim); white-space:nowrap; opacity:0; transition:opacity 0.2s; }
.item-dot:hover .item-q { opacity:1; }
.items-section-label { font-size:9px; color:var(--text-dim); }
.timepoint-separator { margin:12px 0; padding:8px 0; border-top:1px dashed var(--border); }
.timepoint-label { font-size:10px; font-weight:700; text-transform:uppercase; color:var(--accent-yellow); letter-spacing:1px; }

/* PAIRED ANALYSIS */
.paired-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:24px; margin-bottom:20px; }
.paired-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.paired-header h3 { font-size:16px; color:var(--text); }
.change-badge { font-size:12px; padding:4px 12px; border-radius:20px; font-weight:600; }
.change-badge.improved { background:rgba(63,185,80,0.15); color:var(--accent-soc); }
.change-badge.worsened { background:rgba(248,81,73,0.15); color:var(--accent-irr); }
.change-badge.nochange { background:rgba(125,133,144,0.15); color:var(--text-muted); }
.score-comparison { display:grid; grid-template-columns:1fr auto 1fr; gap:16px; align-items:center; }
.score-box { text-align:center; }
.score-box-label { font-size:11px; color:var(--text-muted); text-transform:uppercase; margin-bottom:8px; }
.score-box-value { font-family:'DM Serif Display',serif; font-size:28px; color:var(--text); }
.arrow { font-size:24px; color:var(--text-muted); }

/* TABLE */
.table-wrap { background:var(--surface); border:1px solid var(--border); border-radius:14px; overflow:hidden; margin-top:8px; }
.data-table { width:100%; border-collapse:collapse; font-size:13px; }
.data-table thead tr { background:var(--surface2); border-bottom:1px solid var(--border); }
.data-table th { padding:13px 16px; text-align:left; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); white-space:nowrap; }
.data-table tbody tr { border-bottom:1px solid var(--border); transition:background 0.1s; }
.data-table tbody tr:last-child { border-bottom:none; }
.data-table tbody tr:hover { background:rgba(255,255,255,0.02); }
.data-table td { padding:11px 16px; color:var(--text-muted); vertical-align:middle; }
.mono { font-family:'DM Mono',monospace; }
.no-data-msg { text-align:center; color:var(--text-dim); padding:60px 20px; font-style:italic; font-size:15px; }

/* EMPTY STATE */
.empty-state { text-align:center; padding:80px 20px; color:var(--text-dim); }
.empty-icon { font-size:48px; margin-bottom:16px; opacity:0.4; }
.empty-state h3 { font-family:'DM Serif Display',serif; font-size:22px; color:var(--text-muted); margin-bottom:8px; font-weight:400; }
.empty-state p { font-size:14px; }

/* SECTION HEADER */
.section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:12px; }
.section-header h2 { font-family:'DM Serif Display',serif; font-size:22px; color:var(--text); font-weight:400; }

@media(max-width:768px) {
  .main { padding:20px 16px; }
  .topbar { padding:0 16px; }
  .tabs-bar { padding:0 16px; overflow-x:auto; }
  .participant-grid { grid-template-columns:1fr; }
  .score-comparison { grid-template-columns:1fr; }
  .arrow { transform:rotate(90deg); }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">ğŸ”¬</div>
    <h1>Research Dashboard</h1>
    <p>Pre-Post Intervention Study</p>
    <input type="password" id="pass-input" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Access Dashboard</button>
    <div class="login-error" id="login-err">Incorrect password. Please try again.</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">ğŸ”¬</div>
      <span class="topbar-title">Screen Time Study</span>
      <span class="topbar-badge" id="live-count">0 participants</span>
    </div>
    <div class="topbar-right">
      <button class="top-btn" onclick="refreshAll()">â†» Refresh</button>
      <button class="top-btn secure" onclick="window.open('contact_info.html', '_blank')">ğŸ”’ Contact Info</button>
      <button class="top-btn primary" onclick="doExport()">â¬‡ Export CSV</button>
    </div>
  </div>

  <div class="tabs-bar">
    <button class="tab-btn active" onclick="switchTab('overview', this)">ğŸ“Š Overview</button>
    <button class="tab-btn" onclick="switchTab('participants', this)">ğŸ‘¥ Participants</button>
    <button class="tab-btn" onclick="switchTab('scores', this)">ğŸ“ˆ Score Analysis</button>
    <button class="tab-btn" onclick="switchTab('prepost', this)">ğŸ”„ Pre-Post Changes</button>
    <button class="tab-btn" onclick="switchTab('comparison', this)">âš–ï¸ Group Comparison</button>
    <button class="tab-btn" onclick="switchTab('data', this)">ğŸ—ƒ Raw Data</button>
  </div>

  <div class="main">
    <!-- OVERVIEW -->
    <div class="tab-panel active" id="tab-overview">
      <div class="stat-row" id="overview-stats"></div>
      <div class="chart-grid" id="overview-charts"></div>
    </div>

    <!-- PARTICIPANTS -->
    <div class="tab-panel" id="tab-participants">
      <div class="section-header">
        <h2>Participant List</h2>
      </div>
      <div class="participant-grid" id="participant-grid"></div>
    </div>

    <!-- SCORE ANALYSIS (NEW - All Original Statistics) -->
    <div class="tab-panel" id="tab-scores">
      <div class="section-header">
        <h2>Detailed Score Analysis</h2>
      </div>
      <div class="stat-row" id="score-stats"></div>
      <div class="chart-grid" id="score-charts"></div>
    </div>

    <!-- PRE-POST ANALYSIS -->
    <div class="tab-panel" id="tab-prepost">
      <div class="section-header">
        <h2>Pre-Post Change Analysis</h2>
      </div>
      <div id="prepost-content"></div>
    </div>

    <!-- GROUP COMPARISON -->
    <div class="tab-panel" id="tab-comparison">
      <div class="section-header">
        <h2>Control vs Treatment Groups</h2>
      </div>
      <div class="chart-grid" id="comparison-charts"></div>
    </div>

    <!-- RAW DATA -->
    <div class="tab-panel" id="tab-data">
      <div class="section-header">
        <h2>Raw Data Table</h2>
        <button class="top-btn primary" onclick="doExport()">â¬‡ Export CSV</button>
      </div>
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>Participant ID</th><th>Group</th><th>Time Point</th><th>Date</th>
              <th>Age</th><th>Grade</th><th>Screen Time</th>
              <th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Q5</th>
              <th>Q6</th><th>Q7</th><th>Q8</th><th>Q9</th><th>Q10</th>
              <th>Q11</th><th>Q12</th><th>Q13</th><th>Q14</th><th>Q15</th>
              <th>Irritability</th><th>Attention</th><th>Social</th><th>Total</th>
            </tr>
          </thead>
          <tbody id="raw-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE CONFIGURATION - FILL IN YOUR CREDENTIALS BELOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://dnsmotitaboibecdjzlx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuc21vdGl0YWJvaWJlY2Rqemx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjYzNTQsImV4cCI6MjA4NzA0MjM1NH0.f5QrgqH5kbIWmArXgWixA_ZetLZOqYg7iObskLfH6OI';
const TABLE_RESPONSES = 'survey_responses';
const TABLE_PARTICIPANTS = 'participants';
const PASSWORD = 'research2024';

// Initialize Supabase client
let supabase_client;
try {
  if (typeof supabase === 'undefined') {
    console.error('Supabase library not loaded!');
  } else if (SUPABASE_URL === 'YOUR_SUPABASE_PROJECT_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
    console.error('Supabase credentials not configured!');
  } else {
    supabase_client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('Supabase client initialized successfully');
  }
} catch (err) {
  console.error('Error initializing Supabase:', err);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chartInstances = {};
let cachedParticipants = [];
let cachedResponses = [];

function destroyChart(id) { 
  if (chartInstances[id]) { 
    chartInstances[id].destroy(); 
    delete chartInstances[id]; 
  } 
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTHENTICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLogin() {
  if (document.getElementById('pass-input').value === PASSWORD) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    refreshAll();
  } else {
    document.getElementById('login-err').style.display = 'block';
    document.getElementById('pass-input').value = '';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA FETCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getParticipants() {
  try {
    if (!supabase_client) throw new Error('Database not initialized');
    
    console.log('Fetching participants...');
    const { data, error } = await supabase_client
      .from(TABLE_PARTICIPANTS)
      .select('*')
      .order('participant_id', { ascending: true });

    if (error) throw error;
    
    cachedParticipants = data;
    console.log(`Loaded ${data.length} participants`);
    return data;
  } catch (err) {
    console.error('Error fetching participants:', err);
    alert('Error loading participants: ' + err.message);
    return [];
  }
}

async function getResponses() {
  try {
    if (!supabase_client) throw new Error('Database not initialized');
    
    console.log('Fetching responses...');
    const { data, error } = await supabase_client
      .from(TABLE_RESPONSES)
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;
    
    cachedResponses = data;
    console.log(`Loaded ${data.length} responses`);
    return data;
  } catch (err) {
    console.error('Error fetching responses:', err);
    alert('Error loading responses: ' + err.message);
    return [];
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function avg(arr) { 
  return arr.length ? arr.reduce((a,b) => a+b, 0) / arr.length : 0; 
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(id, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  btn.classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MASTER REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refreshAll() {
  const participants = await getParticipants();
  const responses = await getResponses();
  
  document.getElementById('live-count').textContent = 
    participants.length + ' participant' + (participants.length !== 1 ? 's' : '');
  
  renderOverview(participants, responses);
  renderParticipants(participants);
  renderScoreAnalysis(participants, responses);
  renderPrePost(participants, responses);
  renderComparison(participants, responses);
  renderRawTable(responses, participants);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERVIEW TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOverview(participants, responses) {
  const stats = document.getElementById('overview-stats');
  const charts = document.getElementById('overview-charts');
  
  if (participants.length === 0) {
    stats.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><h3>No participants yet</h3><p>Participants will appear as they complete the survey.</p></div>';
    charts.innerHTML = '';
    return;
  }

  const controlCount = participants.filter(p => p.group_assignment === 'control').length;
  const treatmentCount = participants.filter(p => p.group_assignment === 'treatment').length;
  const baselineComplete = participants.filter(p => p.baseline_completed_at).length;
  const week6Complete = participants.filter(p => p.week6_completed_at).length;
  const bothComplete = participants.filter(p => p.baseline_completed_at && p.week6_completed_at).length;

  stats.innerHTML = `
    <div class="stat-card total">
      <div class="stat-label">Total Participants</div>
      <div class="stat-value">${participants.length}</div>
      <div class="stat-sub">Enrolled in study</div>
    </div>
    <div class="stat-card control">
      <div class="stat-label">Control Group</div>
      <div class="stat-value">${controlCount}</div>
      <div class="stat-sub">${Math.round(controlCount/participants.length*100)}% of total</div>
    </div>
    <div class="stat-card treatment">
      <div class="stat-label">Treatment Group</div>
      <div class="stat-value">${treatmentCount}</div>
      <div class="stat-sub">${Math.round(treatmentCount/participants.length*100)}% of total</div>
    </div>
    <div class="stat-card paired">
      <div class="stat-label">Completed Both</div>
      <div class="stat-value">${bothComplete}</div>
      <div class="stat-sub">${Math.round(bothComplete/participants.length*100)}% retention</div>
    </div>
  `;

  charts.innerHTML = `
    <div class="chart-card">
      <h3>Completion Status</h3>
      <div class="chart-wrap"><canvas id="chart-completion"></canvas></div>
    </div>
    <div class="chart-card">
      <h3>Group Distribution</h3>
      <div class="chart-wrap"><canvas id="chart-groups"></canvas></div>
    </div>
  `;

  // Completion chart
  destroyChart('completion');
  chartInstances['completion'] = new Chart(document.getElementById('chart-completion'), {
    type: 'bar',
    data: {
      labels: ['Baseline Only', 'Week 6 Only', 'Both Complete'],
      datasets: [{
        label: 'Participants',
        data: [baselineComplete - bothComplete, week6Complete - bothComplete, bothComplete],
        backgroundColor: ['rgba(88,166,255,0.7)', 'rgba(210,153,34,0.7)', 'rgba(63,185,80,0.7)'],
        borderColor: ['#58a6ff', '#d29922', '#3fb950'],
        borderWidth: 1,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#7d8590', font: { size: 11 } }, grid: { color: '#21262d' } },
        y: { ticks: { color: '#7d8590', font: { size: 11 }, stepSize: 1 }, grid: { color: '#21262d' } }
      }
    }
  });

  // Group distribution chart
  destroyChart('groups');
  chartInstances['groups'] = new Chart(document.getElementById('chart-groups'), {
    type: 'doughnut',
    data: {
      labels: ['Control', 'Treatment'],
      datasets: [{
        data: [controlCount, treatmentCount],
        backgroundColor: ['rgba(88,166,255,0.7)', 'rgba(248,81,73,0.7)'],
        borderColor: ['#58a6ff', '#f85149'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#7d8590', font: { size: 12 }, padding: 15 }
        }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICIPANTS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderParticipants(participants) {
  const grid = document.getElementById('participant-grid');
  
  if (participants.length === 0) {
    grid.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¤</div><h3>No participants yet</h3></div>';
    return;
  }

  const qLabels = ['Q1','Q2','Q3','Q4','Q5','Q6','Q7','Q8','Q9','Q10','Q11','Q12','Q13','Q14','Q15'];

  grid.innerHTML = participants.map((p, i) => {
    const baselineDone = p.baseline_completed_at ? 'complete' : 'incomplete';
    const week6Done = p.week6_completed_at ? 'complete' : 'incomplete';
    
    // Find responses for this participant
    const baselineResp = cachedResponses.find(r => r.participant_id === p.participant_id && r.time_point === 'baseline');
    const week6Resp = cachedResponses.find(r => r.participant_id === p.participant_id && r.time_point === 'week6');
    
    // Build score bars HTML
    let scoresHtml = '';
    if (baselineResp) {
      scoresHtml = `
        <div class="card-scores">
          <div class="score-row">
            <span class="score-name">Irritability</span>
            <div class="score-track"><div class="score-fill fill-irr" style="width:${baselineResp.irritability/25*100}%"></div></div>
            <span class="score-num">${baselineResp.irritability}<span style="color:var(--text-dim)">/25</span></span>
          </div>
          <div class="score-row">
            <span class="score-name">Attention</span>
            <div class="score-track"><div class="score-fill fill-att" style="width:${baselineResp.attention/25*100}%"></div></div>
            <span class="score-num">${baselineResp.attention}<span style="color:var(--text-dim)">/25</span></span>
          </div>
          <div class="score-row">
            <span class="score-name">Social</span>
            <div class="score-track"><div class="score-fill fill-soc" style="width:${baselineResp.social/25*100}%"></div></div>
            <span class="score-num">${baselineResp.social}<span style="color:var(--text-dim)">/25</span></span>
          </div>
          <div class="score-row">
            <span class="score-name">Total</span>
            <div class="score-track"><div class="score-fill fill-total" style="width:${baselineResp.total/75*100}%"></div></div>
            <span class="score-num">${baselineResp.total}<span style="color:var(--text-dim)">/75</span></span>
          </div>
        </div>`;
    }
    
    // Build item-level responses HTML
    let itemsHtml = '';
    if (baselineResp) {
      const qVals = [baselineResp.q1,baselineResp.q2,baselineResp.q3,baselineResp.q4,baselineResp.q5,
                     baselineResp.q6,baselineResp.q7,baselineResp.q8,baselineResp.q9,baselineResp.q10,
                     baselineResp.q11,baselineResp.q12,baselineResp.q13,baselineResp.q14,baselineResp.q15];
      const dotHtml = qVals.map((v,qi) => `<div class="item-dot dot-${v}"><span class="item-q">${qLabels[qi]}</span>${v}</div>`).join('');
      
      itemsHtml = `
        <div class="card-items">
          <div class="items-label">BASELINE Item-level Responses (Q1â€“Q15)</div>
          <div class="items-grid">${dotHtml}</div>
          <div style="display:flex;justify-content:space-between;margin-top:8px;">
            <span class="items-section-label">Irr (Q1-5) Â· Att (Q6-10) Â· Soc (Q11-15)</span>
          </div>
        </div>`;
      
      // Add week 6 responses if they exist
      if (week6Resp) {
        const qVals6 = [week6Resp.q1,week6Resp.q2,week6Resp.q3,week6Resp.q4,week6Resp.q5,
                       week6Resp.q6,week6Resp.q7,week6Resp.q8,week6Resp.q9,week6Resp.q10,
                       week6Resp.q11,week6Resp.q12,week6Resp.q13,week6Resp.q14,week6Resp.q15];
        const dotHtml6 = qVals6.map((v,qi) => `<div class="item-dot dot-${v}"><span class="item-q">${qLabels[qi]}</span>${v}</div>`).join('');
        
        itemsHtml += `
          <div class="card-items" style="border-top:none; padding-top:0;">
            <div class="timepoint-separator">
              <div class="timepoint-label">WEEK 6</div>
            </div>
            <div class="items-label">WEEK 6 Item-level Responses (Q1â€“Q15)</div>
            <div class="items-grid">${dotHtml6}</div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;">
              <span class="items-section-label">Irr (Q1-5) Â· Att (Q6-10) Â· Soc (Q11-15)</span>
            </div>
          </div>`;
      }
    }
    
    return `
    <div class="participant-card" style="animation-delay:${i*0.03}s">
      <div class="card-header">
        <span class="card-id">ID ${p.participant_id}</span>
        <span class="card-group ${p.group_assignment}">${p.group_assignment}</span>
      </div>
      <div class="card-body">
        <div class="card-row">
          <span class="card-label">Baseline Screen Time:</span>
          <span class="card-value">${p.baseline_screen_time || 'Not yet reported'}</span>
        </div>
        <div class="card-row">
          <span class="card-label">Enrolled:</span>
          <span class="card-value">${new Date(p.created_at).toLocaleDateString()}</span>
        </div>
        ${p.baseline_completed_at ? `
        <div class="card-row">
          <span class="card-label">Baseline:</span>
          <span class="card-value">${new Date(p.baseline_completed_at).toLocaleDateString()}</span>
        </div>` : ''}
        ${p.week6_completed_at ? `
        <div class="card-row">
          <span class="card-label">Week 6:</span>
          <span class="card-value">${new Date(p.week6_completed_at).toLocaleDateString()}</span>
        </div>` : ''}
        <div class="completion-status">
          <div style="display:flex;align-items:center;gap:6px;">
            <div class="status-dot ${baselineDone}"></div>
            <span class="status-label">Baseline</span>
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            <div class="status-dot ${week6Done}"></div>
            <span class="status-label">Week 6</span>
          </div>
        </div>
      </div>
      ${scoresHtml}
      ${itemsHtml}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCORE ANALYSIS TAB (Original Statistics)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderScoreAnalysis(participants, responses) {
  const stats = document.getElementById('score-stats');
  const charts = document.getElementById('score-charts');
  
  if (responses.length === 0) {
    stats.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><h3>No data yet</h3></div>';
    charts.innerHTML = '';
    return;
  }

  // Calculate averages across ALL responses (baseline + week6)
  const avgIrr = avg(responses.map(r => r.irritability));
  const avgAtt = avg(responses.map(r => r.attention));
  const avgSoc = avg(responses.map(r => r.social));
  const avgTotal = avg(responses.map(r => r.total));

  stats.innerHTML = `
    <div class="stat-card total">
      <div class="stat-label">Total Responses</div>
      <div class="stat-value">${responses.length}</div>
      <div class="stat-sub">All survey submissions</div>
    </div>
    <div class="stat-card" style="border-top:3px solid var(--accent-irr);">
      <div class="stat-label">Avg Irritability</div>
      <div class="stat-value">${avgIrr.toFixed(1)}</div>
      <div class="stat-sub">out of 25</div>
    </div>
    <div class="stat-card" style="border-top:3px solid var(--accent-att);">
      <div class="stat-label">Avg Attention</div>
      <div class="stat-value">${avgAtt.toFixed(1)}</div>
      <div class="stat-sub">out of 25</div>
    </div>
    <div class="stat-card" style="border-top:3px solid var(--accent-soc);">
      <div class="stat-label">Avg Social Skills</div>
      <div class="stat-value">${avgSoc.toFixed(1)}</div>
      <div class="stat-sub">out of 25</div>
    </div>
    <div class="stat-card" style="border-top:3px solid var(--accent-purple);">
      <div class="stat-label">Avg Total Score</div>
      <div class="stat-value">${avgTotal.toFixed(1)}</div>
      <div class="stat-sub">out of 75</div>
    </div>
  `;

  // Create bins for distributions
  function makeBins(vals, min, max, n) {
    const size = (max - min) / n;
    const bins = Array(n).fill(0);
    const labels = [];
    for (let i = 0; i < n; i++) {
      labels.push(`${Math.round(min + i*size)}â€“${Math.round(min + (i+1)*size)}`);
    }
    vals.forEach(v => {
      let b = Math.floor((v - min) / size);
      if (b >= n) b = n - 1;
      if (b < 0) b = 0;
      bins[b]++;
    });
    return { bins, labels };
  }

  const irrVals = responses.map(r => r.irritability);
  const attVals = responses.map(r => r.attention);
  const socVals = responses.map(r => r.social);
  const { bins: irrBins, labels: irrLbls } = makeBins(irrVals, 5, 25, 5);
  const { bins: attBins, labels: attLbls } = makeBins(attVals, 5, 25, 5);
  const { bins: socBins, labels: socLbls } = makeBins(socVals, 5, 25, 5);

  charts.innerHTML = `
    <div class="chart-card">
      <h3>Irritability Score Distribution</h3>
      <div class="chart-wrap"><canvas id="chart-irr-dist"></canvas></div>
    </div>
    <div class="chart-card">
      <h3>Attention Score Distribution</h3>
      <div class="chart-wrap"><canvas id="chart-att-dist"></canvas></div>
    </div>
    <div class="chart-card">
      <h3>Social Skills Score Distribution</h3>
      <div class="chart-wrap"><canvas id="chart-soc-dist"></canvas></div>
    </div>
    <div class="chart-card">
      <h3>Screen Time Breakdown</h3>
      <div class="chart-wrap"><canvas id="chart-screen-breakdown"></canvas></div>
    </div>
    <div class="chart-card wide">
      <h3>Average Scores by Screen Time Category</h3>
      <div class="chart-wrap"><canvas id="chart-screen-scores"></canvas></div>
    </div>
  `;

  // Irritability distribution
  destroyChart('irr-dist');
  chartInstances['irr-dist'] = new Chart(document.getElementById('chart-irr-dist'), {
    type: 'bar',
    data: {
      labels: irrLbls,
      datasets: [{
        label: 'Responses',
        data: irrBins,
        backgroundColor: 'rgba(248,81,73,0.7)',
        borderColor: '#f85149',
        borderWidth: 1,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#7d8590', font: { size: 11 } }, grid: { color: '#21262d' } },
        y: { ticks: { color: '#7d8590', font: { size: 11 }, stepSize: 1 }, grid: { color: '#21262d' } }
      }
    }
  });

  // Attention distribution
  destroyChart('att-dist');
  chartInstances['att-dist'] = new Chart(document.getElementById('chart-att-dist'), {
    type: 'bar',
    data: {
      labels: attLbls,
      datasets: [{
        label: 'Responses',
        data: attBins,
        backgroundColor: 'rgba(88,166,255,0.7)',
        borderColor: '#58a6ff',
        borderWidth: 1,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#7d8590', font: { size: 11 } }, grid: { color: '#21262d' } },
        y: { ticks: { color: '#7d8590', font: { size: 11 }, stepSize: 1 }, grid: { color: '#21262d' } }
      }
    }
  });

  // Social distribution
  destroyChart('soc-dist');
  chartInstances['soc-dist'] = new Chart(document.getElementById('chart-soc-dist'), {
    type: 'bar',
    data: {
      labels: socLbls,
      datasets: [{
        label: 'Responses',
        data: socBins,
        backgroundColor: 'rgba(63,185,80,0.7)',
        borderColor: '#3fb950',
        borderWidth: 1,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#7d8590', font: { size: 11 } }, grid: { color: '#21262d' } },
        y: { ticks: { color: '#7d8590', font: { size: 11 }, stepSize: 1 }, grid: { color: '#21262d' } }
      }
    }
  });

  // Screen time breakdown
  const stCounts = {};
  responses.forEach(r => {
    stCounts[r.screen_time] = (stCounts[r.screen_time] || 0) + 1;
  });
  const stLabels = Object.keys(stCounts);
  const stData = stLabels.map(k => stCounts[k]);
  const pieColors = ['#3fb950','#58a6ff','#d29922','#f85149','#bc8cff','#ffa657'];

  destroyChart('screen-breakdown');
  chartInstances['screen-breakdown'] = new Chart(document.getElementById('chart-screen-breakdown'), {
    type: 'doughnut',
    data: {
      labels: stLabels,
      datasets: [{
        data: stData,
        backgroundColor: pieColors,
        borderColor: '#161b22',
        borderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#7d8590', font: { size: 11 }, padding: 12 }
        }
      }
    }
  });

  // Average scores by screen time
  const stOrder = ['Less than 1 hour','1â€“2 hours','2â€“4 hours','4â€“6 hours','6+ hours'];
  const stGroups = {};
  stOrder.forEach(s => { stGroups[s] = { irr: [], att: [], soc: [] }; });
  responses.forEach(r => {
    if (stGroups[r.screen_time]) {
      stGroups[r.screen_time].irr.push(r.irritability);
      stGroups[r.screen_time].att.push(r.attention);
      stGroups[r.screen_time].soc.push(r.social);
    }
  });
  const stLabelsFiltered = stOrder.filter(s => stGroups[s].irr.length > 0);
  const stIrrAvg = stLabelsFiltered.map(s => avg(stGroups[s].irr));
  const stAttAvg = stLabelsFiltered.map(s => avg(stGroups[s].att));
  const stSocAvg = stLabelsFiltered.map(s => avg(stGroups[s].soc));

  destroyChart('screen-scores');
  chartInstances['screen-scores'] = new Chart(document.getElementById('chart-screen-scores'), {
    type: 'bar',
    data: {
      labels: stLabelsFiltered,
      datasets: [
        {
          label: 'Avg Irritability',
          data: stIrrAvg,
          backgroundColor: 'rgba(248,81,73,0.75)',
          borderColor: '#f85149',
          borderWidth: 1,
          borderRadius: 6
        },
        {
          label: 'Avg Attention',
          data: stAttAvg,
          backgroundColor: 'rgba(88,166,255,0.75)',
          borderColor: '#58a6ff',
          borderWidth: 1,
          borderRadius: 6
        },
        {
          label: 'Avg Social Skills',
          data: stSocAvg,
          backgroundColor: 'rgba(63,185,80,0.75)',
          borderColor: '#3fb950',
          borderWidth: 1,
          borderRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#7d8590', font: { size: 12 } }
        }
      },
      scales: {
        x: { ticks: { color: '#7d8590' }, grid: { color: '#21262d' } },
        y: {
          min: 0,
          max: 25,
          ticks: { color: '#7d8590' },
          grid: { color: '#21262d' }
        }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRE-POST ANALYSIS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPrePost(participants, responses) {
  const content = document.getElementById('prepost-content');
  
  const paired = participants.filter(p => p.baseline_completed_at && p.week6_completed_at);
  
  if (paired.length === 0) {
    content.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“ˆ</div><h3>No paired data yet</h3><p>Participants must complete both baseline and week 6 surveys.</p></div>';
    return;
  }

  content.innerHTML = paired.map(p => {
    const baseline = responses.find(r => r.participant_id === p.participant_id && r.time_point === 'baseline');
    const week6 = responses.find(r => r.participant_id === p.participant_id && r.time_point === 'week6');
    
    if (!baseline || !week6) return '';

    const irrChange = week6.irritability - baseline.irritability;
    const attChange = week6.attention - baseline.attention;
    const socChange = week6.social - baseline.social;
    const totalChange = week6.total - baseline.total;
    
    const overallStatus = totalChange < -2 ? 'improved' : totalChange > 2 ? 'worsened' : 'nochange';
    const overallLabel = totalChange < -2 ? 'â†“ Improved' : totalChange > 2 ? 'â†‘ Worsened' : 'â†’ No Change';
    
    return `
    <div class="paired-card">
      <div class="paired-header">
        <h3>ID ${p.participant_id} â€” <span style="color:${p.group_assignment === 'treatment' ? 'var(--accent-treatment)' : 'var(--accent-control)'};">${p.group_assignment}</span></h3>
        <span class="change-badge ${overallStatus}">${overallLabel} (${totalChange > 0 ? '+' : ''}${totalChange})</span>
      </div>
      
      <div class="score-comparison">
        <div class="score-box">
          <div class="score-box-label">Baseline</div>
          <div class="score-box-value">${baseline.total}</div>
          <div style="font-size:11px;color:var(--text-dim);margin-top:4px;">
            I:${baseline.irritability} A:${baseline.attention} S:${baseline.social}
          </div>
        </div>
        <div class="arrow">â†’</div>
        <div class="score-box">
          <div class="score-box-label">Week 6</div>
          <div class="score-box-value" style="color:${overallStatus === 'improved' ? 'var(--accent-soc)' : overallStatus === 'worsened' ? 'var(--accent-irr)' : 'var(--text)'}">${week6.total}</div>
          <div style="font-size:11px;color:var(--text-dim);margin-top:4px;">
            I:${week6.irritability} A:${week6.attention} S:${week6.social}
          </div>
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px;font-size:12px;">
        <div style="text-align:center;">
          <div style="color:var(--text-muted);">Irritability</div>
          <div style="font-weight:600;color:${irrChange < 0 ? 'var(--accent-soc)' : irrChange > 0 ? 'var(--accent-irr)' : 'var(--text)'};">
            ${irrChange > 0 ? '+' : ''}${irrChange}
          </div>
        </div>
        <div style="text-align:center;">
          <div style="color:var(--text-muted);">Attention</div>
          <div style="font-weight:600;color:${attChange < 0 ? 'var(--accent-soc)' : attChange > 0 ? 'var(--accent-irr)' : 'var(--text)'};">
            ${attChange > 0 ? '+' : ''}${attChange}
          </div>
        </div>
        <div style="text-align:center;">
          <div style="color:var(--text-muted);">Social</div>
          <div style="font-weight:600;color:${socChange < 0 ? 'var(--accent-soc)' : socChange > 0 ? 'var(--accent-irr)' : 'var(--text)'};">
            ${socChange > 0 ? '+' : ''}${socChange}
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GROUP COMPARISON TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderComparison(participants, responses) {
  const charts = document.getElementById('comparison-charts');
  
  const pairedParticipants = participants.filter(p => p.baseline_completed_at && p.week6_completed_at);
  
  if (pairedParticipants.length === 0) {
    charts.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-icon">âš–ï¸</div><h3>Need paired data</h3><p>Comparison requires participants who completed both surveys.</p></div>';
    return;
  }

  const controlPaired = pairedParticipants.filter(p => p.group_assignment === 'control');
  const treatmentPaired = pairedParticipants.filter(p => p.group_assignment === 'treatment');

  const controlChanges = controlPaired.map(p => {
    const b = responses.find(r => r.participant_id === p.participant_id && r.time_point === 'baseline');
    const w = responses.find(r => r.participant_id === p.participant_id && r.time_point === 'week6');
    return { irr: w.irritability - b.irritability, att: w.attention - b.attention, soc: w.social - b.social };
  });

  const treatmentChanges = treatmentPaired.map(p => {
    const b = responses.find(r => r.participant_id === p.participant_id && r.time_point === 'baseline');
    const w = responses.find(r => r.participant_id === p.participant_id && r.time_point === 'week6');
    return { irr: w.irritability - b.irritability, att: w.attention - b.attention, soc: w.social - b.social };
  });

  const controlAvg = {
    irr: avg(controlChanges.map(c => c.irr)),
    att: avg(controlChanges.map(c => c.att)),
    soc: avg(controlChanges.map(c => c.soc))
  };

  const treatmentAvg = {
    irr: avg(treatmentChanges.map(c => c.irr)),
    att: avg(treatmentChanges.map(c => c.att)),
    soc: avg(treatmentChanges.map(c => c.soc))
  };

  charts.innerHTML = `
    <div class="chart-card wide">
      <h3>Average Score Changes by Group (Baseline â†’ Week 6)</h3>
      <div class="chart-wrap-tall"><canvas id="chart-group-changes"></canvas></div>
    </div>
  `;

  destroyChart('group-changes');
  chartInstances['group-changes'] = new Chart(document.getElementById('chart-group-changes'), {
    type: 'bar',
    data: {
      labels: ['Irritability', 'Attention', 'Social Skills'],
      datasets: [
        {
          label: 'Control Group',
          data: [controlAvg.irr, controlAvg.att, controlAvg.soc],
          backgroundColor: 'rgba(88,166,255,0.7)',
          borderColor: '#58a6ff',
          borderWidth: 1,
          borderRadius: 6
        },
        {
          label: 'Treatment Group',
          data: [treatmentAvg.irr, treatmentAvg.att, treatmentAvg.soc],
          backgroundColor: 'rgba(248,81,73,0.7)',
          borderColor: '#f85149',
          borderWidth: 1,
          borderRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#7d8590', font: { size: 13 }, padding: 15 }
        }
      },
      scales: {
        x: { ticks: { color: '#7d8590', font: { size: 12 } }, grid: { color: '#21262d' } },
        y: { 
          ticks: { color: '#7d8590', font: { size: 12 } }, 
          grid: { color: '#21262d' },
          title: { display: true, text: 'Average Change in Score', color: '#7d8590' }
        }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RAW DATA TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRawTable(responses, participants) {
  const body = document.getElementById('raw-table-body');
  
  if (responses.length === 0) {
    body.innerHTML = '<tr><td colspan="26" class="no-data-msg">No responses yet.</td></tr>';
    return;
  }

  body.innerHTML = responses.map(r => {
    const participant = participants.find(p => p.participant_id === r.participant_id);
    const date = new Date(r.created_at).toLocaleDateString();
    
    return `<tr>
      <td class="mono">${r.participant_id}</td>
      <td>${participant?.group_assignment || 'â€”'}</td>
      <td>${r.time_point}</td>
      <td>${date}</td>
      <td>${r.age || 'â€”'}</td>
      <td>${r.grade}</td>
      <td>${r.screen_time}</td>
      <td class="mono">${r.q1}</td>
      <td class="mono">${r.q2}</td>
      <td class="mono">${r.q3}</td>
      <td class="mono">${r.q4}</td>
      <td class="mono">${r.q5}</td>
      <td class="mono">${r.q6}</td>
      <td class="mono">${r.q7}</td>
      <td class="mono">${r.q8}</td>
      <td class="mono">${r.q9}</td>
      <td class="mono">${r.q10}</td>
      <td class="mono">${r.q11}</td>
      <td class="mono">${r.q12}</td>
      <td class="mono">${r.q13}</td>
      <td class="mono">${r.q14}</td>
      <td class="mono">${r.q15}</td>
      <td class="mono">${r.irritability}</td>
      <td class="mono">${r.attention}</td>
      <td class="mono">${r.social}</td>
      <td class="mono">${r.total}</td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doExport() {
  if (cachedResponses.length === 0) {
    alert('No data to export yet.');
    return;
  }

  const headers = ['Participant_ID','Group','Time_Point','Date','Age','Grade','Screen_Time','Q1','Q2','Q3','Q4','Q5','Q6','Q7','Q8','Q9','Q10','Q11','Q12','Q13','Q14','Q15','Irritability','Attention','Social','Total'];
  
  const rows = cachedResponses.map(r => {
    const participant = cachedParticipants.find(p => p.participant_id === r.participant_id);
    return [
      r.participant_id,
      participant?.group_assignment || '',
      r.time_point,
      r.created_at,
      r.age || '',
      r.grade,
      r.screen_time,
      r.q1,r.q2,r.q3,r.q4,r.q5,r.q6,r.q7,r.q8,r.q9,r.q10,r.q11,r.q12,r.q13,r.q14,r.q15,
      r.irritability,
      r.attention,
      r.social,
      r.total
    ];
  });

  const csv = [headers,...rows].map(row => row.map(v => `"${v}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'screen_time_study_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
