<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Research Dashboard ‚Äî Screen Time Survey</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:#0d1117; --surface:#161b22; --surface2:#1c2330; --border:#21262d; --border2:#30363d;
  --text:#e6edf3; --text-muted:#7d8590; --text-dim:#484f58;
  --accent-irr:#f85149; --accent-att:#58a6ff; --accent-soc:#3fb950; --accent-yellow:#d29922;
  --accent-purple:#bc8cff; --accent-orange:#ffa657;
}
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'Outfit',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

/* LOGIN */
#login-screen { min-height:100vh; display:flex; align-items:center; justify-content:center;
  background:radial-gradient(ellipse at 30% 20%, rgba(88,166,255,0.07) 0%, transparent 60%),
              radial-gradient(ellipse at 70% 80%, rgba(248,81,73,0.06) 0%, transparent 60%), var(--bg); }
.login-box { background:var(--surface); border:1px solid var(--border2); border-radius:20px; padding:52px 44px; width:380px; text-align:center; box-shadow:0 24px 64px rgba(0,0,0,0.5); }
.login-logo { width:56px; height:56px; background:linear-gradient(135deg,#58a6ff,#bc8cff); border-radius:14px; display:flex; align-items:center; justify-content:center; margin:0 auto 24px; font-size:26px; }
.login-box h1 { font-family:'DM Serif Display',serif; font-size:24px; color:var(--text); margin-bottom:6px; }
.login-box p { color:var(--text-muted); font-size:14px; margin-bottom:32px; }
.login-box input { width:100%; padding:13px 16px; background:var(--bg); border:1px solid var(--border2); border-radius:10px; color:var(--text); font-family:'DM Mono',monospace; font-size:15px; outline:none; transition:border-color 0.2s; margin-bottom:14px; letter-spacing:2px; }
.login-box input:focus { border-color:#58a6ff; }
.login-btn { width:100%; padding:13px; background:linear-gradient(135deg,#1f6feb,#388bfd); color:#fff; border:none; border-radius:10px; font-family:'Outfit',sans-serif; font-size:16px; font-weight:600; cursor:pointer; transition:opacity 0.2s, transform 0.15s; }
.login-btn:hover { opacity:0.9; transform:translateY(-1px); }
.login-error { color:var(--accent-irr); font-size:13px; margin-top:12px; display:none; }

/* APP */
#app { display:none; min-height:100vh; }
.topbar { background:var(--surface); border-bottom:1px solid var(--border); padding:0 32px; height:60px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
.topbar-left { display:flex; align-items:center; gap:14px; }
.topbar-logo { width:32px; height:32px; background:linear-gradient(135deg,#58a6ff,#bc8cff); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:16px; }
.topbar-title { font-family:'DM Serif Display',serif; font-size:18px; color:var(--text); }
.topbar-badge { background:rgba(63,185,80,0.15); color:var(--accent-soc); font-size:11px; font-weight:600; padding:3px 10px; border-radius:20px; letter-spacing:1px; text-transform:uppercase; }
.topbar-right { display:flex; align-items:center; gap:10px; }
.top-btn { padding:7px 16px; border-radius:7px; border:1px solid var(--border2); background:transparent; color:var(--text-muted); font-family:'Outfit',sans-serif; font-size:13px; font-weight:500; cursor:pointer; transition:all 0.15s; }
.top-btn:hover { background:var(--surface2); color:var(--text); }
.top-btn.primary { background:#1f6feb; border-color:#1f6feb; color:#fff; }
.top-btn.primary:hover { background:#388bfd; }
.top-btn.danger { border-color:rgba(248,81,73,0.4); color:var(--accent-irr); }
.top-btn.danger:hover { background:rgba(248,81,73,0.15); }

/* TABS */
.tabs-bar { background:var(--surface); border-bottom:1px solid var(--border); padding:0 32px; display:flex; gap:4px; }
.tab-btn { padding:14px 20px; font-family:'Outfit',sans-serif; font-size:14px; font-weight:500; color:var(--text-muted); background:none; border:none; cursor:pointer; border-bottom:2px solid transparent; transition:all 0.15s; white-space:nowrap; }
.tab-btn:hover { color:var(--text); }
.tab-btn.active { color:var(--accent-att); border-bottom-color:var(--accent-att); }

.main { padding:32px; max-width:1280px; margin:0 auto; }
.tab-panel { display:none; }
.tab-panel.active { display:block; }

/* STAT CARDS */
.stat-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px; margin-bottom:32px; }
.stat-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:22px 24px; position:relative; overflow:hidden; transition:border-color 0.2s; }
.stat-card:hover { border-color:var(--border2); }
.stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; border-radius:14px 14px 0 0; }
.stat-card.irr::before { background:var(--accent-irr); }
.stat-card.att::before { background:var(--accent-att); }
.stat-card.soc::before { background:var(--accent-soc); }
.stat-card.total::before { background:var(--accent-purple); }
.stat-card.count::before { background:var(--accent-soc); }
.stat-label { font-size:11px; text-transform:uppercase; letter-spacing:1.5px; color:var(--text-muted); font-weight:600; margin-bottom:10px; }
.stat-value { font-family:'DM Serif Display',serif; font-size:36px; color:var(--text); line-height:1; }
.stat-sub { font-size:12px; color:var(--text-dim); margin-top:6px; }
.stat-badge { display:inline-block; font-size:11px; font-weight:600; padding:3px 9px; border-radius:20px; margin-top:8px; }
.badge-low { background:rgba(63,185,80,0.12); color:#3fb950; }
.badge-mod { background:rgba(210,153,34,0.12); color:#d29922; }
.badge-high { background:rgba(248,81,73,0.12); color:#f85149; }
.badge-vhigh { background:rgba(248,81,73,0.2); color:#f85149; font-weight:800; }

/* CHARTS */
.chart-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:28px; }
@media(max-width:900px) { .chart-grid { grid-template-columns:1fr; } }
.chart-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:24px; }
.chart-card h3 { font-size:13px; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); font-weight:600; margin-bottom:20px; }
.chart-wrap { position:relative; height:240px; }
.chart-wrap-tall { position:relative; height:300px; }
.chart-card.wide { grid-column:span 2; }
@media(max-width:900px) { .chart-card.wide { grid-column:span 1; } }

/* SECTION HEADER */
.section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:12px; }
.section-header h2 { font-family:'DM Serif Display',serif; font-size:22px; color:var(--text); font-weight:400; }
.filter-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.filter-select { padding:7px 12px; background:var(--surface2); border:1px solid var(--border2); border-radius:8px; color:var(--text-muted); font-family:'Outfit',sans-serif; font-size:13px; outline:none; cursor:pointer; }
.filter-select:focus { border-color:var(--accent-att); color:var(--text); }

/* RESPONDENT CARDS */
.respondent-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:18px; }
.respondent-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; overflow:hidden; transition:border-color 0.2s, box-shadow 0.2s; animation:fadeUp 0.4s ease both; }
@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
.respondent-card:hover { border-color:var(--border2); box-shadow:0 8px 24px rgba(0,0,0,0.3); }
.card-header { padding:18px 20px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
.card-id { font-family:'DM Mono',monospace; font-size:12px; color:var(--text-dim); }
.card-date { font-size:12px; color:var(--text-dim); }
.card-meta { padding:14px 20px; border-bottom:1px solid var(--border); display:flex; gap:16px; flex-wrap:wrap; }
.meta-item { display:flex; flex-direction:column; gap:2px; }
.meta-key { font-size:10px; text-transform:uppercase; letter-spacing:1px; color:var(--text-dim); font-weight:600; }
.meta-val { font-size:13px; color:var(--text-muted); font-weight:500; }
.card-scores { padding:16px 20px; border-bottom:1px solid var(--border); }
.score-row { display:flex; align-items:center; gap:12px; margin-bottom:10px; }
.score-row:last-child { margin-bottom:0; }
.score-name { font-size:12px; color:var(--text-muted); font-weight:600; width:92px; flex-shrink:0; text-transform:uppercase; letter-spacing:0.8px; }
.score-track { flex:1; height:7px; background:var(--bg); border-radius:4px; overflow:hidden; }
.score-fill { height:100%; border-radius:4px; transition:width 0.6s ease; }
.fill-irr { background:linear-gradient(90deg,#f85149,#ffa657); }
.fill-att { background:linear-gradient(90deg,#58a6ff,#bc8cff); }
.fill-soc { background:linear-gradient(90deg,#3fb950,#58a6ff); }
.fill-total { background:linear-gradient(90deg,#bc8cff,#ffa657); }
.score-num { font-family:'DM Mono',monospace; font-size:13px; color:var(--text); font-weight:500; width:46px; text-align:right; flex-shrink:0; }
.card-items { padding:14px 20px 18px; }
.items-label { font-size:10px; text-transform:uppercase; letter-spacing:1px; color:var(--text-dim); font-weight:600; margin-bottom:10px; }
.items-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:6px; }
.item-dot { aspect-ratio:1; border-radius:8px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; font-size:14px; font-weight:700; font-family:'DM Mono',monospace; }
.item-dot .item-q { font-size:9px; opacity:0.6; font-family:'Outfit',sans-serif; font-weight:600; letter-spacing:0.5px; }
.dot-1 { background:rgba(63,185,80,0.12); color:#3fb950; }
.dot-2 { background:rgba(63,185,80,0.08); color:#6cbe78; }
.dot-3 { background:rgba(210,153,34,0.12); color:#d29922; }
.dot-4 { background:rgba(248,81,73,0.12); color:#f85149; }
.dot-5 { background:rgba(248,81,73,0.2); color:#f85149; }
.items-section-label { font-size:10px; color:var(--text-dim); text-align:center; margin-top:4px; letter-spacing:0.5px; }

/* ANALYTICS */
.insight-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px; margin-bottom:28px; }
.insight-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:22px 24px; }
.insight-card h4 { font-size:12px; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); margin-bottom:14px; font-weight:600; }
.correlation-display { font-family:'DM Serif Display',serif; font-size:48px; color:var(--text); line-height:1; margin-bottom:6px; }
.correlation-label { font-size:13px; color:var(--text-muted); }

/* TABLE */
.table-wrap { background:var(--surface); border:1px solid var(--border); border-radius:14px; overflow:hidden; margin-top:8px; }
.data-table { width:100%; border-collapse:collapse; font-size:13px; }
.data-table thead tr { background:var(--surface2); border-bottom:1px solid var(--border); }
.data-table th { padding:13px 16px; text-align:left; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); white-space:nowrap; }
.data-table tbody tr { border-bottom:1px solid var(--border); transition:background 0.1s; }
.data-table tbody tr:last-child { border-bottom:none; }
.data-table tbody tr:hover { background:rgba(255,255,255,0.02); }
.data-table td { padding:11px 16px; color:var(--text-muted); vertical-align:middle; }
.mono { font-family:'DM Mono',monospace; }
.score-chip { display:inline-flex; align-items:center; padding:3px 10px; border-radius:20px; font-weight:700; font-family:'DM Mono',monospace; font-size:12px; }
.no-data-msg { text-align:center; color:var(--text-dim); padding:60px 20px; font-style:italic; font-size:15px; }

/* EMPTY STATE */
.empty-state { text-align:center; padding:80px 20px; color:var(--text-dim); }
.empty-icon { font-size:48px; margin-bottom:16px; opacity:0.4; }
.empty-state h3 { font-family:'DM Serif Display',serif; font-size:22px; color:var(--text-muted); margin-bottom:8px; font-weight:400; }
.empty-state p { font-size:14px; }

/* EXPORT */
.export-panel { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:24px; margin-top:24px; }
.export-panel h3 { font-size:13px; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:14px; font-weight:600; }
.export-panel textarea { width:100%; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text-muted); font-family:'DM Mono',monospace; font-size:12px; padding:14px; height:140px; resize:vertical; outline:none; }

@media(max-width:768px) {
  .main { padding:20px 16px; }
  .topbar { padding:0 16px; }
  .tabs-bar { padding:0 16px; overflow-x:auto; }
  .respondent-grid { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">üî¨</div>
    <h1>Research Dashboard</h1>
    <p>Screen Time & Child Behavior Study</p>
    <input type="password" id="pass-input" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Access Dashboard</button>
    <div class="login-error" id="login-err">Incorrect password. Please try again.</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">üî¨</div>
      <span class="topbar-title">Screen Time Study</span>
      <span class="topbar-badge" id="live-count">0 responses</span>
    </div>
    <div class="topbar-right">
      <button class="top-btn" onclick="refreshAll()">‚Üª Refresh</button>
      <button class="top-btn primary" onclick="doExport()">‚¨á Export CSV</button>
      <button class="top-btn danger" onclick="clearAll()">‚úï Clear</button>
    </div>
  </div>

  <div class="tabs-bar">
    <button class="tab-btn active" onclick="switchTab('overview', this)">üìä Overview</button>
    <button class="tab-btn" onclick="switchTab('respondents', this)">üë§ Individual Respondents</button>
    <button class="tab-btn" onclick="switchTab('analytics', this)">üìà Trends & Analytics</button>
    <button class="tab-btn" onclick="switchTab('data', this)">üóÉ Raw Data</button>
  </div>

  <div class="main">
    <!-- OVERVIEW -->
    <div class="tab-panel active" id="tab-overview">
      <div class="stat-row" id="stat-row"></div>
      <div class="chart-grid" id="overview-charts"></div>
    </div>

    <!-- RESPONDENTS -->
    <div class="tab-panel" id="tab-respondents">
      <div class="section-header">
        <h2>Individual Respondents</h2>
        <div class="filter-row">
          <select class="filter-select" id="sort-select" onchange="renderRespondents()">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="irr-high">Irritability ‚Üì</option>
            <option value="att-high">Attention ‚Üì</option>
            <option value="soc-high">Social Skills ‚Üì</option>
            <option value="total-high">Total Score ‚Üì</option>
          </select>
          <select class="filter-select" id="screen-filter" onchange="renderRespondents()">
            <option value="all">All Screen Times</option>
            <option value="Less than 1 hour">Less than 1 hr</option>
            <option value="1‚Äì2 hours">1‚Äì2 hrs</option>
            <option value="2‚Äì4 hours">2‚Äì4 hrs</option>
            <option value="4‚Äì6 hours">4‚Äì6 hrs</option>
            <option value="6+ hours">6+ hrs</option>
          </select>
        </div>
      </div>
      <div class="respondent-grid" id="respondent-grid"></div>
    </div>

    <!-- ANALYTICS -->
    <div class="tab-panel" id="tab-analytics">
      <div class="insight-row" id="insight-row"></div>
      <div class="chart-grid" id="analytics-charts"></div>
    </div>

    <!-- RAW DATA -->
    <div class="tab-panel" id="tab-data">
      <div class="section-header">
        <h2>Raw Data Table</h2>
        <button class="top-btn primary" onclick="doExport()">‚¨á Export CSV</button>
      </div>
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th><th>Date</th><th>Age</th><th>Grade</th><th>Screen Time</th>
              <th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Q5</th>
              <th>Q6</th><th>Q7</th><th>Q8</th><th>Q9</th><th>Q10</th>
              <th>Q11</th><th>Q12</th><th>Q13</th><th>Q14</th><th>Q15</th>
              <th>Irritability</th><th>Attention</th><th>Social</th><th>Total</th>
            </tr>
          </thead>
          <tbody id="raw-table-body"></tbody>
        </table>
      </div>
      <div class="export-panel">
        <h3>CSV Export</h3>
        <textarea id="csv-area" readonly placeholder="Click Export CSV to generate‚Ä¶"></textarea>
      </div>
    </div>
  </div>
</div>

<script>
const STORAGE_KEY = 'screentime_survey_v2';
const PASSWORD = 'research2024';
let chartInstances = {};

function destroyChart(id) { if (chartInstances[id]) { chartInstances[id].destroy(); delete chartInstances[id]; } }
async function doLogin() {
  const pass = document.getElementById('pass-input').value;
  if (pass === 'admin123') { // Change to your actual password
    
    // 1. Fetch data from Supabase instead of LocalStorage
    const { data, error } = await _supabase
      .from('survey_responses')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      alert("Error loading data: " + error.message);
      return;
    }

    // 2. Save the data to a global variable so charts can see it
    window.allData = data; 
    
    // 3. Reveal the dashboard
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    
    // 4. Run your render functions
    refreshAll(); 
  } else {
    document.getElementById('login-err').style.display = 'block';
  }
}

const supabaseUrl = 'https://dnsmotitaboibecdjzlx.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuc21vdGl0YWJvaWJlY2Rqemx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjYzNTQsImV4cCI6MjA4NzA0MjM1NH0.f5QrgqH5kbIWmArXgWixA_ZetLZOqYg7iObskLfH6OI';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// Replace your old getData function
async function refreshAll() {
  const { data, error } = await _supabase
    .from('survey_responses')
    .select('*')
    .order('created_at', { ascending: false });

  if (error) {
    console.error('Error fetching data:', error);
    return;
  }

  // Update your global data variable and re-render charts
  window.allData = data; 
  renderStats();
  renderCharts();
  renderRespondents();
  updateLiveCount(data.length);
}

// Call refreshAll() when the user logs in
async function doLogin() {
  const pass = document.getElementById('pass-input').value;
  if (pass === 'your_password') { // You should use Supabase Auth for real security
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    await refreshAll();
  } else {
    document.getElementById('login-err').style.display = 'block';
  }
}
}
function scoreLevelChip(s, max) {
  const p = s / max;
  if (p <= 0.33) return 'background:rgba(63,185,80,0.12);color:#3fb950';
  if (p <= 0.55) return 'background:rgba(210,153,34,0.12);color:#d29922';
  if (p <= 0.75) return 'background:rgba(248,81,73,0.12);color:#f85149';
  return 'background:rgba(248,81,73,0.2);color:#f85149';
}
function avg(arr) { return arr.length ? arr.reduce((a,b) => a+b, 0) / arr.length : 0; }
function pearson(xs, ys) {
  if (xs.length < 3) return null;
  const mx = avg(xs), my = avg(ys);
  let num = 0, dx2 = 0, dy2 = 0;
  xs.forEach((x, i) => { const dx = x-mx, dy = ys[i]-my; num += dx*dy; dx2 += dx*dx; dy2 += dy*dy; });
  const denom = Math.sqrt(dx2 * dy2);
  return denom === 0 ? 0 : num / denom;
}

function switchTab(id, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  btn.classList.add('active');
  refreshAll();
}

function refreshAll() {
  const data = getData();
  document.getElementById('live-count').textContent = data.length + ' response' + (data.length !== 1 ? 's' : '');
  renderOverview(data);
  renderRespondents();
  renderAnalytics(data);
  renderRawTable(data);
}

// OVERVIEW
function renderOverview(data) {
  const sr = document.getElementById('stat-row');
  sr.innerHTML = '';
  if (data.length === 0) {
    sr.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><h3>No responses yet</h3><p>Responses will appear here once parents complete the survey.</p></div>';
    document.getElementById('overview-charts').innerHTML = '';
    return;
  }
  const avgIrr = avg(data.map(r => r.irritability));
  const avgAtt = avg(data.map(r => r.attention));
  const avgSoc = avg(data.map(r => r.social));
  const avgTot = avg(data.map(r => r.total));
  const [iLbl, iCls] = scoreLevel(avgIrr, 25);
  const [aLbl, aCls] = scoreLevel(avgAtt, 25);
  const [sLbl, sCls] = scoreLevel(avgSoc, 25);

  sr.innerHTML = `
    <div class="stat-card count"><div class="stat-label">Total Responses</div><div class="stat-value">${data.length}</div><div class="stat-sub">Collected so far</div></div>
    <div class="stat-card irr"><div class="stat-label">Avg Irritability</div><div class="stat-value">${avgIrr.toFixed(1)}</div><div class="stat-sub">out of 25</div><span class="stat-badge ${iCls}">${iLbl}</span></div>
    <div class="stat-card att"><div class="stat-label">Avg Attention</div><div class="stat-value">${avgAtt.toFixed(1)}</div><div class="stat-sub">out of 25</div><span class="stat-badge ${aCls}">${aLbl}</span></div>
    <div class="stat-card soc"><div class="stat-label">Avg Social Skills</div><div class="stat-value">${avgSoc.toFixed(1)}</div><div class="stat-sub">out of 25</div><span class="stat-badge ${sCls}">${sLbl}</span></div>
    <div class="stat-card total"><div class="stat-label">Avg Total Score</div><div class="stat-value">${avgTot.toFixed(1)}</div><div class="stat-sub">out of 75</div></div>
  `;

  const oc = document.getElementById('overview-charts');
  oc.innerHTML = `
    <div class="chart-card"><h3>Score Distribution ‚Äî Irritability</h3><div class="chart-wrap"><canvas id="chart-irr-dist"></canvas></div></div>
    <div class="chart-card"><h3>Score Distribution ‚Äî Attention</h3><div class="chart-wrap"><canvas id="chart-att-dist"></canvas></div></div>
    <div class="chart-card"><h3>Score Distribution ‚Äî Social Skills</h3><div class="chart-wrap"><canvas id="chart-soc-dist"></canvas></div></div>
    <div class="chart-card"><h3>Screen Time Breakdown</h3><div class="chart-wrap"><canvas id="chart-screen-pie"></canvas></div></div>
  `;

  function makeBins(vals, min, max, n) {
    const size = (max - min) / n;
    const bins = Array(n).fill(0);
    const labels = [];
    for (let i = 0; i < n; i++) labels.push(`${Math.round(min + i*size)}‚Äì${Math.round(min + (i+1)*size)}`);
    vals.forEach(v => {
      let b = Math.floor((v - min) / size);
      if (b >= n) b = n - 1;
      bins[b]++;
    });
    return { bins, labels };
  }

  const irrVals = data.map(r => r.irritability);
  const attVals = data.map(r => r.attention);
  const socVals = data.map(r => r.social);
  const { bins: irrBins, labels: irrLbls } = makeBins(irrVals, 5, 25, 5);
  const { bins: attBins, labels: attLbls } = makeBins(attVals, 5, 25, 5);
  const { bins: socBins, labels: socLbls } = makeBins(socVals, 5, 25, 5);

  destroyChart('irr-dist');
  chartInstances['irr-dist'] = new Chart(document.getElementById('chart-irr-dist'), {
    type: 'bar',
    data: { labels: irrLbls, datasets: [{ label: 'Respondents', data: irrBins, backgroundColor: 'rgba(248,81,73,0.7)', borderColor: '#f85149', borderWidth: 1, borderRadius: 6 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#7d8590', font: { size: 11 } }, grid: { color: '#21262d' } }, y: { ticks: { color: '#7d8590', font: { size: 11 }, stepSize: 1 }, grid: { color: '#21262d' } } } }
  });

  destroyChart('att-dist');
  chartInstances['att-dist'] = new Chart(document.getElementById('chart-att-dist'), {
    type: 'bar',
    data: { labels: attLbls, datasets: [{ label: 'Respondents', data: attBins, backgroundColor: 'rgba(88,166,255,0.7)', borderColor: '#58a6ff', borderWidth: 1, borderRadius: 6 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#7d8590', font: { size: 11 } }, grid: { color: '#21262d' } }, y: { ticks: { color: '#7d8590', font: { size: 11 }, stepSize: 1 }, grid: { color: '#21262d' } } } }
  });

  destroyChart('soc-dist');
  chartInstances['soc-dist'] = new Chart(document.getElementById('chart-soc-dist'), {
    type: 'bar',
    data: { labels: socLbls, datasets: [{ label: 'Respondents', data: socBins, backgroundColor: 'rgba(63,185,80,0.7)', borderColor: '#3fb950', borderWidth: 1, borderRadius: 6 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#7d8590', font: { size: 11 } }, grid: { color: '#21262d' } }, y: { ticks: { color: '#7d8590', font: { size: 11 }, stepSize: 1 }, grid: { color: '#21262d' } } } }
  });

  const stCounts = {};
  data.forEach(r => { stCounts[r.screenTime] = (stCounts[r.screenTime] || 0) + 1; });
  const stLabels = Object.keys(stCounts);
  const stData = stLabels.map(k => stCounts[k]);
  const pieColors = ['#3fb950','#58a6ff','#d29922','#f85149','#bc8cff','#ffa657'];

  destroyChart('screen-pie');
  chartInstances['screen-pie'] = new Chart(document.getElementById('chart-screen-pie'), {
    type: 'doughnut',
    data: { labels: stLabels, datasets: [{ data: stData, backgroundColor: pieColors, borderColor: '#161b22', borderWidth: 3 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#7d8590', font: { size: 11 }, padding: 12 } } } }
  });
}

// RESPONDENTS
function renderRespondents() {
  let data = getData();
  if (data.length === 0) {
    document.getElementById('respondent-grid').innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üë§</div><h3>No responses yet</h3><p>Individual respondent cards will appear here after parents complete the survey.</p></div>`;
    return;
  }

  const sort = document.getElementById('sort-select').value;
  const screenF = document.getElementById('screen-filter').value;
  if (screenF !== 'all') data = data.filter(r => r.screenTime === screenF);

  if (sort === 'newest') data = [...data].sort((a,b) => b.id - a.id);
  else if (sort === 'oldest') data = [...data].sort((a,b) => a.id - b.id);
  else if (sort === 'irr-high') data = [...data].sort((a,b) => b.irritability - a.irritability);
  else if (sort === 'att-high') data = [...data].sort((a,b) => b.attention - a.attention);
  else if (sort === 'soc-high') data = [...data].sort((a,b) => b.social - a.social);
  else if (sort === 'total-high') data = [...data].sort((a,b) => b.total - a.total);

  const qLabels = ['Q1','Q2','Q3','Q4','Q5','Q6','Q7','Q8','Q9','Q10','Q11','Q12','Q13','Q14','Q15'];
  const grid = document.getElementById('respondent-grid');

  if (data.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üîç</div><h3>No matches</h3><p>Try a different filter.</p></div>';
    return;
  }

  grid.innerHTML = data.map((r, i) => {
    const date = new Date(r.timestamp).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
    const time = new Date(r.timestamp).toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });
    const qVals = [r.q1,r.q2,r.q3,r.q4,r.q5,r.q6,r.q7,r.q8,r.q9,r.q10,r.q11,r.q12,r.q13,r.q14,r.q15];
    const dotHtml = qVals.map((v,qi) => `<div class="item-dot dot-${v}"><span class="item-q">${qLabels[qi]}</span>${v}</div>`).join('');

    return `
    <div class="respondent-card" style="animation-delay:${i*0.04}s">
      <div class="card-header">
        <span class="card-id">ID #${String(i+1).padStart(3,'0')}</span>
        <span class="card-date">${date} ¬∑ ${time}</span>
      </div>
      <div class="card-meta">
        <div class="meta-item"><span class="meta-key">Age</span><span class="meta-val">${r.age || '‚Äî'}</span></div>
        <div class="meta-item"><span class="meta-key">Grade</span><span class="meta-val">${r.grade}</span></div>
        <div class="meta-item"><span class="meta-key">Screen Time</span><span class="meta-val">${r.screenTime}</span></div>
        <div class="meta-item"><span class="meta-key">Role</span><span class="meta-val">${r.role}</span></div>
      </div>
      <div class="card-scores">
        <div class="score-row">
          <span class="score-name">Irritability</span>
          <div class="score-track"><div class="score-fill fill-irr" style="width:${r.irritability/25*100}%"></div></div>
          <span class="score-num">${r.irritability}<span style="color:var(--text-dim)">/25</span></span>
        </div>
        <div class="score-row">
          <span class="score-name">Attention</span>
          <div class="score-track"><div class="score-fill fill-att" style="width:${r.attention/25*100}%"></div></div>
          <span class="score-num">${r.attention}<span style="color:var(--text-dim)">/25</span></span>
        </div>
        <div class="score-row">
          <span class="score-name">Social</span>
          <div class="score-track"><div class="score-fill fill-soc" style="width:${r.social/25*100}%"></div></div>
          <span class="score-num">${r.social}<span style="color:var(--text-dim)">/25</span></span>
        </div>
        <div class="score-row">
          <span class="score-name">Total</span>
          <div class="score-track"><div class="score-fill fill-total" style="width:${r.total/75*100}%"></div></div>
          <span class="score-num">${r.total}<span style="color:var(--text-dim)">/75</span></span>
        </div>
      </div>
      <div class="card-items">
        <div class="items-label">Item-level responses (Q1‚ÄìQ15)</div>
        <div class="items-grid">${dotHtml}</div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;">
          <span class="items-section-label">Irr (Q1-5) ¬∑ Att (Q6-10) ¬∑ Soc (Q11-15)</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ANALYTICS
function renderAnalytics(data) {
  const ac = document.getElementById('analytics-charts');
  const ir = document.getElementById('insight-row');
  ac.innerHTML = '';
  ir.innerHTML = '';

  if (data.length < 2) {
    ac.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üìà</div><h3>Need more data</h3><p>Analytics require at least 2 responses to generate trends and correlations.</p></div>`;
    return;
  }

  const stMids = data.map(r => r.screenTimeMid || 0);
  const irrScores = data.map(r => r.irritability);
  const attScores = data.map(r => r.attention);
  const socScores = data.map(r => r.social);

  const corrIrrSt = pearson(stMids, irrScores);
  const corrAttSt = pearson(stMids, attScores);
  const corrSocSt = pearson(stMids, socScores);

  function corrDesc(r) {
    if (r === null) return 'Insufficient data';
    const a = Math.abs(r);
    const dir = r > 0 ? 'positive' : 'negative';
    if (a < 0.2) return 'Negligible ' + dir;
    if (a < 0.4) return 'Weak ' + dir;
    if (a < 0.6) return 'Moderate ' + dir;
    if (a < 0.8) return 'Strong ' + dir;
    return 'Very strong ' + dir;
  }

  ir.innerHTML = `
    <div class="insight-card"><h4>Screen Time √ó Irritability</h4><div class="correlation-display">${corrIrrSt !== null ? corrIrrSt.toFixed(2) : '‚Äî'}</div><div class="correlation-label">Pearson r ¬∑ ${corrDesc(corrIrrSt)}</div></div>
    <div class="insight-card"><h4>Screen Time √ó Attention</h4><div class="correlation-display">${corrAttSt !== null ? corrAttSt.toFixed(2) : '‚Äî'}</div><div class="correlation-label">Pearson r ¬∑ ${corrDesc(corrAttSt)}</div></div>
    <div class="insight-card"><h4>Screen Time √ó Social Skills</h4><div class="correlation-display">${corrSocSt !== null ? corrSocSt.toFixed(2) : '‚Äî'}</div><div class="correlation-label">Pearson r ¬∑ ${corrDesc(corrSocSt)}</div></div>
  `;

  const stOrder = ['Less than 1 hour','1‚Äì2 hours','2‚Äì4 hours','4‚Äì6 hours','6+ hours'];
  const stGroups = {};
  stOrder.forEach(s => { stGroups[s] = { irr: [], att: [], soc: [] }; });
  data.forEach(r => { if (stGroups[r.screenTime]) { stGroups[r.screenTime].irr.push(r.irritability); stGroups[r.screenTime].att.push(r.attention); stGroups[r.screenTime].soc.push(r.social); } });
  const stLabels = stOrder.filter(s => stGroups[s].irr.length > 0);
  const stIrrAvg = stLabels.map(s => avg(stGroups[s].irr));
  const stAttAvg = stLabels.map(s => avg(stGroups[s].att));
  const stSocAvg = stLabels.map(s => avg(stGroups[s].soc));

  ac.innerHTML = `
    <div class="chart-card wide"><h3>Average Scores by Daily Screen Time Group</h3><div class="chart-wrap"><canvas id="chart-stgroup"></canvas></div></div>
  `;

  destroyChart('stgroup');
  chartInstances['stgroup'] = new Chart(document.getElementById('chart-stgroup'), {
    type: 'bar',
    data: {
      labels: stLabels,
      datasets: [
        { label: 'Avg Irritability', data: stIrrAvg, backgroundColor: 'rgba(248,81,73,0.75)', borderColor:'#f85149', borderWidth:1, borderRadius:6 },
        { label: 'Avg Attention', data: stAttAvg, backgroundColor: 'rgba(88,166,255,0.75)', borderColor:'#58a6ff', borderWidth:1, borderRadius:6 },
        { label: 'Avg Social Skills', data: stSocAvg, backgroundColor: 'rgba(63,185,80,0.75)', borderColor:'#3fb950', borderWidth:1, borderRadius:6 }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#7d8590', font:{size:12} } } }, scales: { x: { ticks:{color:'#7d8590'}, grid:{color:'#21262d'} }, y: { min:0, max:25, ticks:{color:'#7d8590'}, grid:{color:'#21262d'} } } }
  });
}

// RAW TABLE
function renderRawTable(data) {
  const body = document.getElementById('raw-table-body');
  if (data.length === 0) {
    body.innerHTML = '<tr><td colspan="24" class="no-data-msg">No data yet.</td></tr>';
    return;
  }
  body.innerHTML = data.map((r, i) => {
    const date = new Date(r.timestamp).toLocaleDateString();
    return `<tr>
      <td class="mono" style="color:#7d8590">${i+1}</td>
      <td>${date}</td>
      <td>${r.age || '‚Äî'}</td>
      <td>${r.grade}</td>
      <td>${r.screenTime}</td>
      <td class="mono">${r.q1}</td><td class="mono">${r.q2}</td><td class="mono">${r.q3}</td><td class="mono">${r.q4}</td><td class="mono">${r.q5}</td>
      <td class="mono">${r.q6}</td><td class="mono">${r.q7}</td><td class="mono">${r.q8}</td><td class="mono">${r.q9}</td><td class="mono">${r.q10}</td>
      <td class="mono">${r.q11}</td><td class="mono">${r.q12}</td><td class="mono">${r.q13}</td><td class="mono">${r.q14}</td><td class="mono">${r.q15}</td>
      <td><span class="score-chip" style="${scoreLevelChip(r.irritability,25)}">${r.irritability}/25</span></td>
      <td><span class="score-chip" style="${scoreLevelChip(r.attention,25)}">${r.attention}/25</span></td>
      <td><span class="score-chip" style="${scoreLevelChip(r.social,25)}">${r.social}/25</span></td>
      <td><span class="score-chip" style="${scoreLevelChip(r.total,75)}">${r.total}/75</span></td>
    </tr>`;
  }).join('');
}

// EXPORT
function doExport() {
  const data = getData();
  if (data.length === 0) { alert('No data to export yet.'); return; }
  const headers = ['#','Timestamp','Age','Grade','Screen Time','Role','Q1','Q2','Q3','Q4','Q5','Q6','Q7','Q8','Q9','Q10','Q11','Q12','Q13','Q14','Q15','Irritability','Attention','Social','Total'];
  const rows = data.map((r,i) => [i+1, r.timestamp, r.age||'', r.grade, r.screenTime, r.role, r.q1,r.q2,r.q3,r.q4,r.q5,r.q6,r.q7,r.q8,r.q9,r.q10,r.q11,r.q12,r.q13,r.q14,r.q15,r.irritability,r.attention,r.social,r.total]);
  const csv = [headers,...rows].map(row => row.map(v=>`"${v}"`).join(',')).join('\n');
  const ta = document.getElementById('csv-area');
  if (ta) ta.value = csv;
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'screen_time_survey_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function clearAll() {
  if (confirm('Delete ALL survey responses permanently?')) {
    localStorage.removeItem(STORAGE_KEY);
    refreshAll();
  }
}
</script>
</body>
</html>
